"""
CloudFlare API客户端

实现CloudFlare域名管理和DNS配置功能
"""

from typing import Optional, Dict, List
import cloudflare
from loguru import logger

from .utils import retry_with_exponential_backoff


class CloudFlareError(Exception):
    """CloudFlare操作错误"""
    
    def __init__(self, message: str, error_code: Optional[str] = None):
        super().__init__(message)
        self.error_code = error_code


class CloudFlareManager:
    """CloudFlare管理器"""
    
    def __init__(self, api_token: str, account_id: str = None):
        """
        初始化CloudFlare管理器
        
        Args:
            api_token: CloudFlare API令牌
            account_id: CloudFlare账户ID
        """
        if not api_token:
            raise CloudFlareError("CloudFlare API Token不能为空")
        
        try:
            self.cf = cloudflare.Cloudflare(api_token=api_token)
            self.api_token = api_token
            self.account_id = account_id
            logger.debug("CloudFlare客户端初始化完成")
        except Exception as e:
            raise CloudFlareError(f"CloudFlare客户端初始化失败: {str(e)}")
    
    @retry_with_exponential_backoff()
    def validate_credentials(self) -> bool:
        """
        验证CloudFlare API凭据
        
        Returns:
            凭据是否有效
        """
        try:
            logger.debug("正在验证CloudFlare API凭据...")
            # 尝试获取用户信息来验证凭据
            user = self.cf.user.get()
            if user and user.id:
                logger.info("CloudFlare API凭据验证成功")
                return True
            else:
                logger.error("CloudFlare API凭据验证失败：无效响应")
                return False
                
        except Exception as e:
            logger.error(f"CloudFlare API凭据验证失败: {str(e)}")
            return False
    
    @retry_with_exponential_backoff()
    def add_zone(self, domain: str) -> Optional[str]:
        """
        添加域名到CloudFlare
        
        Args:
            domain: 域名
            
        Returns:
            Zone ID，如果添加失败则返回None
            
        Raises:
            CloudFlareError: 当添加失败时
        """
        try:
            logger.info(f"正在添加域名到CloudFlare: {domain}")
            
            # 检查域名是否已存在
            existing_zone_id = self.check_zone_exists(domain)
            if existing_zone_id:
                logger.info(f"域名 {domain} 已存在于CloudFlare，Zone ID: {existing_zone_id}")
                return existing_zone_id
            
            # 添加新域名
            zone_data = {
                "name": domain,
                "type": "full"  # 完整设置
            }
            
            # 添加账户ID（如果提供）
            if self.account_id:
                zone_data["account"] = {"id": self.account_id}
            
            response = self.cf.zones.create(**zone_data)
            
            if response and response.id:
                zone_id = response.id
                logger.info(f"域名 {domain} 添加成功，Zone ID: {zone_id}")
                return zone_id
            else:
                error_msg = f"添加域名失败，未获得有效的Zone ID: {domain}"
                logger.error(error_msg)
                raise CloudFlareError(error_msg)
                
        except cloudflare.APIError as e:
            error_msg = f"CloudFlare API错误 [{domain}]: {str(e)}"
            logger.error(error_msg)
            raise CloudFlareError(error_msg, error_code=getattr(e, 'code', None))
        except Exception as e:
            error_msg = f"添加域名到CloudFlare失败 [{domain}]: {str(e)}"
            logger.error(error_msg)
            raise CloudFlareError(error_msg)
    
    @retry_with_exponential_backoff()
    def check_zone_exists(self, domain: str) -> Optional[str]:
        """
        检查域名是否已在CloudFlare中存在
        
        Args:
            domain: 域名
            
        Returns:
            Zone ID，如果不存在则返回None
        """
        try:
            logger.debug(f"检查域名是否存在: {domain}")
            
            zones = self.cf.zones.list(name=domain)
            
            # 处理分页响应
            zone_list = list(zones)
            if zone_list and len(zone_list) > 0:
                zone_id = zone_list[0].id
                logger.debug(f"域名 {domain} 已存在，Zone ID: {zone_id}")
                return zone_id
            else:
                logger.debug(f"域名 {domain} 不存在于CloudFlare")
                return None
                
        except cloudflare.APIError as e:
            logger.error(f"检查域名存在性失败 [{domain}]: {str(e)}")
            return None
        except Exception as e:
            logger.error(f"检查域名存在性时发生错误 [{domain}]: {str(e)}")
            return None
    
    @retry_with_exponential_backoff()
    def get_zone_info(self, zone_id: str) -> Optional[Dict]:
        """
        获取Zone详细信息
        
        Args:
            zone_id: Zone ID
            
        Returns:
            Zone信息字典
        """
        try:
            logger.debug(f"获取Zone信息: {zone_id}")
            zone = self.cf.zones.get(zone_id=zone_id)
            
            if zone:
                return {
                    'id': zone.id,
                    'name': zone.name,
                    'status': zone.status,
                    'name_servers': zone.name_servers or [],
                    'created_on': zone.created_on,
                    'modified_on': zone.modified_on
                }
            else:
                return None
                
        except cloudflare.APIError as e:
            logger.error(f"获取Zone信息失败 [{zone_id}]: {str(e)}")
            return None
        except Exception as e:
            logger.error(f"获取Zone信息时发生错误 [{zone_id}]: {str(e)}")
            return None
    
    @retry_with_exponential_backoff()
    def get_nameservers(self, zone_id: str) -> Optional[List[str]]:
        """
        获取CloudFlare分配的名称服务器
        
        Args:
            zone_id: Zone ID
            
        Returns:
            名称服务器列表
        """
        try:
            zone_info = self.get_zone_info(zone_id)
            if zone_info and 'name_servers' in zone_info:
                return zone_info['name_servers']
            else:
                return None
                
        except Exception as e:
            logger.error(f"获取名称服务器失败 [{zone_id}]: {str(e)}")
            return None

    @retry_with_exponential_backoff()
    def create_dns_record(self, zone_id: str, record_type: str, name: str, content: str, ttl: int = 300, proxied: bool = False) -> Optional[str]:
        """
        创建DNS记录
        
        Args:
            zone_id: Zone ID
            record_type: 记录类型 (A, AAAA, CNAME, MX, TXT等)
            name: 记录名称
            content: 记录内容
            ttl: TTL值
            proxied: 是否启用代理
            
        Returns:
            记录ID，如果创建失败则返回None
        """
        try:
            logger.info(f"创建DNS记录: {name} {record_type} {content}")
            
            record_data = {
                "type": record_type,
                "name": name,
                "content": content,
                "ttl": ttl,
                "proxied": proxied
            }
            
            response = self.cf.dns.records.create(zone_id=zone_id, **record_data)
            
            if response and response.id:
                logger.info(f"DNS记录创建成功: {name} -> {response.id}")
                return response.id
            else:
                logger.error(f"DNS记录创建失败: {name}")
                return None
                
        except cloudflare.APIError as e:
            logger.error(f"创建DNS记录失败 [{name}]: {str(e)}")
            return None
        except Exception as e:
            logger.error(f"创建DNS记录时发生错误 [{name}]: {str(e)}")
            return None

    @retry_with_exponential_backoff()
    def list_dns_records(self, zone_id: str, record_type: str = None) -> List[Dict]:
        """
        列出DNS记录
        
        Args:
            zone_id: Zone ID
            record_type: 记录类型过滤器
            
        Returns:
            DNS记录列表
        """
        try:
            logger.debug(f"获取DNS记录列表: {zone_id}")
            
            params = {}
            if record_type:
                params['type'] = record_type
                
            records = self.cf.dns.records.list(zone_id=zone_id, **params)
            
            record_list = []
            for record in records:
                record_info = {
                    'id': record.id,
                    'type': record.type,
                    'name': record.name,
                    'content': record.content,
                    'ttl': record.ttl,
                    'proxied': record.proxied if hasattr(record, 'proxied') else False
                }
                record_list.append(record_info)
            
            logger.debug(f"获取到 {len(record_list)} 条DNS记录")
            return record_list
            
        except cloudflare.APIError as e:
            logger.error(f"获取DNS记录列表失败 [{zone_id}]: {str(e)}")
            return []
        except Exception as e:
            logger.error(f"获取DNS记录列表时发生错误 [{zone_id}]: {str(e)}")
            return []

    @retry_with_exponential_backoff()
    def set_ssl_mode(self, zone_id: str, ssl_mode: str = "flexible") -> bool:
        """
        设置SSL模式
        
        Args:
            zone_id: Zone ID
            ssl_mode: SSL模式 (off, flexible, full, strict)
            
        Returns:
            是否设置成功
        """
        try:
            logger.info(f"设置SSL模式: {ssl_mode}")
            
            ssl_data = {
                "value": ssl_mode
            }
            
            response = self.cf.zones.settings.ssl.edit(zone_id=zone_id, **ssl_data)
            
            if response and response.value == ssl_mode:
                logger.info(f"SSL模式设置成功: {ssl_mode}")
                return True
            else:
                logger.error(f"SSL模式设置失败: {ssl_mode}")
                return False
                
        except cloudflare.APIError as e:
            logger.error(f"设置SSL模式失败 [{ssl_mode}]: {str(e)}")
            return False
        except Exception as e:
            logger.error(f"设置SSL模式时发生错误 [{ssl_mode}]: {str(e)}")
            return False

    @retry_with_exponential_backoff()
    def get_ssl_mode(self, zone_id: str) -> Optional[str]:
        """
        获取当前SSL模式
        
        Args:
            zone_id: Zone ID
            
        Returns:
            SSL模式
        """
        try:
            logger.debug(f"获取SSL模式: {zone_id}")
            
            response = self.cf.zones.settings.ssl.get(zone_id=zone_id)
            
            if response and response.value:
                logger.debug(f"当前SSL模式: {response.value}")
                return response.value
            else:
                logger.warning(f"无法获取SSL模式")
                return None
                
        except cloudflare.APIError as e:
            logger.error(f"获取SSL模式失败 [{zone_id}]: {str(e)}")
            return None
        except Exception as e:
            logger.error(f"获取SSL模式时发生错误 [{zone_id}]: {str(e)}")
            return None

    @retry_with_exponential_backoff()
    def create_basic_dns_records(self, zone_id: str, domain: str, target_ip: str = None) -> List[Dict]:
        """
        创建基础DNS记录
        
        Args:
            zone_id: Zone ID
            domain: 域名
            target_ip: 目标IP地址（可选）
            
        Returns:
            创建的记录列表
        """
        try:
            logger.info(f"创建基础DNS记录: {domain}")
            
            created_records = []
            
            # 如果提供了IP地址，创建A记录
            if target_ip:
                # 根域名A记录
                root_record = self.create_dns_record(zone_id, "A", domain, target_ip, proxied=True)
                if root_record:
                    created_records.append({"type": "A", "name": domain, "content": target_ip, "id": root_record})
                
                # www子域名A记录
                www_record = self.create_dns_record(zone_id, "A", f"www.{domain}", target_ip, proxied=True)
                if www_record:
                    created_records.append({"type": "A", "name": f"www.{domain}", "content": target_ip, "id": www_record})
            else:
                # 如果没有提供IP，创建CNAME记录指向根域名
                www_cname = self.create_dns_record(zone_id, "CNAME", f"www.{domain}", domain, proxied=True)
                if www_cname:
                    created_records.append({"type": "CNAME", "name": f"www.{domain}", "content": domain, "id": www_cname})
            
            logger.info(f"基础DNS记录创建完成: {len(created_records)} 条记录")
            return created_records
            
        except Exception as e:
            logger.error(f"创建基础DNS记录失败 [{domain}]: {str(e)}")
            return []
    
    @retry_with_exponential_backoff()
    def list_zones(self) -> List[Dict]:
        """
        列出所有Zone
        
        Returns:
            Zone列表
        """
        try:
            logger.debug("获取所有Zone列表...")
            zones = self.cf.zones.list()
            
            zone_list = []
            # 处理分页响应
            for zone in zones:
                zone_info = {
                    'id': zone.id,
                    'name': zone.name,
                    'status': zone.status,
                    'name_servers': zone.name_servers or [],
                }
                zone_list.append(zone_info)
            
            logger.debug(f"获取到 {len(zone_list)} 个Zone")
            return zone_list
            
        except cloudflare.APIError as e:
            logger.error(f"获取Zone列表失败: {str(e)}")
            return []
        except Exception as e:
            logger.error(f"获取Zone列表时发生错误: {str(e)}")
            return []
    
    @retry_with_exponential_backoff()
    def delete_zone(self, zone_id: str) -> bool:
        """
        删除Zone（谨慎使用）
        
        Args:
            zone_id: Zone ID
            
        Returns:
            是否删除成功
        """
        try:
            logger.warning(f"正在删除Zone: {zone_id}")
            response = self.cf.zones.delete(zone_id=zone_id)
            
            if response:
                logger.info(f"Zone删除成功: {zone_id}")
                return True
            else:
                logger.error(f"Zone删除失败: {zone_id}")
                return False
                
        except cloudflare.APIError as e:
            logger.error(f"删除Zone失败 [{zone_id}]: {str(e)}")
            return False
        except Exception as e:
            logger.error(f"删除Zone时发生错误 [{zone_id}]: {str(e)}")
            return False
    
    def get_stats(self) -> Dict[str, int]:
        """
        获取CloudFlare账户统计信息
        
        Returns:
            统计信息字典
        """
        try:
            zones = self.list_zones()
            
            stats = {
                'total_zones': len(zones),
                'active_zones': len([z for z in zones if z.get('status') == 'active']),
                'pending_zones': len([z for z in zones if z.get('status') == 'pending']),
            }
            
            return stats
            
        except Exception as e:
            logger.error(f"获取CloudFlare统计信息失败: {str(e)}")
            return {
                'total_zones': 0,
                'active_zones': 0,
                'pending_zones': 0,
            } 